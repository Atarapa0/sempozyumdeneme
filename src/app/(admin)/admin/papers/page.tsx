'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useAuth } from '@/lib/context/AuthContext';
import { userService } from '@/lib/services';
import apiClient from '@/lib/apiClient';
import { bildiriService } from '@/lib/services';
import { sempozyumService } from '@/lib/services';
import { revizeService } from '@/lib/services/revize.service';
import { revizeGecmisiService } from '@/lib/services/revize-gecmisi.service';
import { getBildiriKonulari } from '@/lib/services/bildiri-konusu.service';

// Paper interface'ini tanƒ±mlayalƒ±m
interface Paper {
  id: string;
  title: string;
  authors: string[];
  abstract: string;
  paperTopicId: string;
  paperTopicTitle: string;
  mainTopicId: string;
  status: string;
  submissionDate: string;
  hakemIds: number[];
  reviewers: string[];
  dokuman?: string;
}

interface Message {
  type: 'success' | 'error' | '';
  text: string;
}

// Revizyon detaylarƒ± i√ßin interface
interface RevizeDetay {
  id?: number;
  gucluYonler?: string;
  zayifYonler?: string;
  genelYorum?: string;
  hakemId?: number;
  hakemAdi?: string;
  durum?: string;
  guvenSeviyesi?: number;
  createdAt?: string;
  updatedAt?: string;
  makaleTuru?: string;
  makaleBasligi?: string;
  soyut?: string;
  anahtarKelimeler?: string;
  giris?: string;
  gerekcelerVeYontemler?: string;
  sonuclarVeTartismalar?: string;
  referanslar?: string;
  guncellikVeOzgunluk?: string;
  sempozyumId?: number;
  bildiriId?: number;
  revizeTarihi?: string; // RevizeGecmisi tablosundan gelen alan
}

export default function AdminPapers() {
  const { user } = useAuth();
  const router = useRouter();
  
  const [papers, setPapers] = useState<Paper[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedStatus, setSelectedStatus] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('');
  const [selectedPaper, setSelectedPaper] = useState<Paper | null>(null);
  const [isReviewerModalOpen, setIsReviewerModalOpen] = useState(false);
  const [selectedReviewers, setSelectedReviewers] = useState<string[]>([]);
  const [availableReviewers, setAvailableReviewers] = useState<string[]>([]);
  const [message, setMessage] = useState<Message>({ type: '', text: '' });
  const [reviewers, setReviewers] = useState<string[]>([]);
  const [reviewerInfo, setReviewerInfo] = useState<Array<{id: number, name: string, email: string, expertise?: string[]}>>([]);
  const [reviewerSearchTerm, setReviewerSearchTerm] = useState<string>('');
  const [aktifSempozyumId, setAktifSempozyumId] = useState<number | null>(null);
  const [isPreviewModalOpen, setIsPreviewModalOpen] = useState(false);
  const [previewPaper, setPreviewPaper] = useState<Paper | null>(null);
  const [revizyonDetaylari, setRevizyonDetaylari] = useState<RevizeDetay[]>([]);
  const [revizyonYukleniyor, setRevizyonYukleniyor] = useState(false);
  
  // Admin kontrol√º
  const isAdmin = user?.role === 'admin';
  
  // Admin deƒüilse ana sayfaya y√∂nlendir
  useEffect(() => {
    if (!user) {
      router.push('/login');
      return;
    }

    if (!isAdmin) {
      router.push('/');
      return;
    }

    // Aktif sempozyumu getir
    getAktifSempozyum();
    
    // API'den hakemleri √ßek
    fetchReviewers();
    
    // Sayfa her odaklandƒ±ƒüƒ±nda bildiri durumlarƒ±nƒ± yenile
    const handleFocus = () => {
      console.log('Sayfa odaklandƒ±, bildiri durumlarƒ± yenileniyor...');
      if (aktifSempozyumId) {
        fetchPapers(aktifSempozyumId);
      } else {
        getAktifSempozyum();
      }
    };
    
    // Sayfa y√ºklendiƒüinde ve her g√∂r√ºn√ºr olduƒüunda yenile
    window.addEventListener('focus', handleFocus);
    
    // Temizleme fonksiyonu
    return () => {
      window.removeEventListener('focus', handleFocus);
    };
  }, [user, isAdmin, router, aktifSempozyumId]);

  // Aktif sempozyumu otomatik yenileme i√ßin useEffect - 60 saniyelik interval
  // useEffect(() => {
  //   // Eƒüer aktif sempozyum ID varsa, 60 saniyede bir yenile
  //   if (aktifSempozyumId) {
  //     console.log('Otomatik yenileme ba≈ülatƒ±ldƒ± (60 saniye)');
  //     
  //     const interval = setInterval(() => {
  //       console.log('60 saniye doldu, veriler yenileniyor...');
  //       fetchPapers(aktifSempozyumId);
  //     }, 60000); // 60 saniye
  //     
  //     // Temizleme fonksiyonu
  //     return () => {
  //       console.log('Otomatik yenileme interval durduruldu');
  //       clearInterval(interval);
  //     };
  //   }
  // }, [aktifSempozyumId]);
  
  // Aktif sempozyumu getir
  const getAktifSempozyum = async () => {
    try {
      const aktifSempozyum = await sempozyumService.getAktifSempozyum();
      if (aktifSempozyum) {
        setAktifSempozyumId(aktifSempozyum.id);
        console.log('Aktif sempozyum ID:', aktifSempozyum.id);
        fetchPapers(aktifSempozyum.id);
      } else {
        setMessage({
          type: 'error',
          text: 'Aktif sempozyum bulunamadƒ±. L√ºtfen √∂nce bir sempozyumu aktif hale getirin.'
        });
        setPapers([]);
        setLoading(false);
      }
    } catch (error) {
      console.error('Aktif sempozyum getirme hatasƒ±:', error);
      setMessage({
        type: 'error',
        text: 'Aktif sempozyum bilgisi alƒ±namadƒ±. L√ºtfen sayfayƒ± yenileyin.'
      });
      setLoading(false);
    }
  };

  // API'den hakemleri √ßek
  const fetchReviewers = async () => {
    setLoading(true);
    try {
      console.log('üîç Hakemler getiriliyor...');
      
      // Hata mesajƒ±nƒ± temizle
      setMessage({ type: '', text: '' });
      
      // /api/users yerine /kullanici/hakemler endpointini kullanalƒ±m
      const reviewerUsers = await userService.getReviewers();
      
      console.log('üìä API Yanƒ±tƒ± - T√ºm hakemler:', JSON.stringify(reviewerUsers));
      
      if (!reviewerUsers || reviewerUsers.length === 0) {
        console.warn('‚ö†Ô∏è API yanƒ±tƒ± bo≈ü veya undefined. Hakem bulunamadƒ±!');
        setMessage({
          type: 'error',
          text: 'Veritabanƒ±nda hakem rol√ºne sahip kullanƒ±cƒ± bulunamadƒ±! L√ºtfen √∂nce hakem ekleyin.'
        });
        setReviewers([]);
        setReviewerInfo([]);
        return;
      }
      
      // API'den gelen hakem verilerini i≈üle
      const reviewerNames = reviewerUsers.map(reviewer => {
        if (!reviewer || !reviewer.ad || !reviewer.soyad) {
          console.warn('Eksik hakem bilgisi:', reviewer);
          return null;
        }
        
        // Hakem yeteneklerini t√ºm detayƒ±yla konsola yazdƒ±r
        console.log(`Ham hakem bilgisi (${reviewer.ad} ${reviewer.soyad}):`, JSON.stringify(reviewer, null, 2));
        
        // hakem_yetenekleri alanƒ±nƒ±n doƒürudan i√ßeriƒüini kontrol et
        if ((reviewer as any).hakem_yetenekleri) {
          console.log(`üèÜüèÜüèÜ Hakem ${reviewer.ad} ${reviewer.soyad} i√ßin hakem_yetenekleri MEVCUT!`);
          console.log(` - Ham deƒüer:`, (reviewer as any).hakem_yetenekleri);
          console.log(` - Tipi:`, typeof (reviewer as any).hakem_yetenekleri);
          console.log(` - JSON ise:`, JSON.stringify((reviewer as any).hakem_yetenekleri));
        } else {
          console.warn(`‚ö†Ô∏è Hakem ${reviewer.ad} ${reviewer.soyad} i√ßin hakem_yetenekleri BULUNAMADI!`);
          
          // Alternatif alanlarda da yoksa tam olarak bo≈ü d√∂n√ºyordur
          console.warn(`  Olasƒ± alanlarƒ± kontrol ediyorum...`);
          
          if ((reviewer as any).yetenekler) {
            console.log(`  ‚úì Hakem ${reviewer.ad} ${reviewer.soyad} i√ßin yetenekler MEVCUT!`, (reviewer as any).yetenekler);
          }
          
          if ((reviewer as any).expertise) {
            console.log(`  ‚úì Hakem ${reviewer.ad} ${reviewer.soyad} i√ßin expertise MEVCUT!`, (reviewer as any).expertise);
          }
          
          // Hakem nesnesini tam olarak incele - belki farklƒ± bir anahtar kullanƒ±lƒ±yor
          const possibleFields = Object.keys(reviewer);
          console.log(`  Mevcut t√ºm alanlar:`, possibleFields);
          
          // yeteneklerle ilgili anahtar kelimeleri i√ßeren alanlarƒ± ara
          const potentialExpertiseFields = possibleFields.filter(field => 
            field.includes('yetenekler') || 
            field.includes('expertise') || 
            field.includes('hakem') || 
            field.includes('uzman') || 
            field.includes('alan')
          );
          
          if (potentialExpertiseFields.length > 0) {
            console.log(`  Potansiyel yetenek alanlarƒ±:`, potentialExpertiseFields);
            potentialExpertiseFields.forEach(field => {
              console.log(`    ${field}:`, (reviewer as any)[field]);
            });
          }
        }
        
        // Hakem yetenekleri i√ßin t√ºm olasƒ± alanlarƒ± kontrol edelim
        const hakemYetenekleri = (reviewer as any).hakem_yetenekleri || 
                               (reviewer as any).yetenekler || 
                               (reviewer as any).expertise || 
                               (reviewer as any).hakem?.yetenekler || 
                               null;
        
        console.log(`Hakem yetenekleri detaylƒ± (${reviewer.ad} ${reviewer.soyad}):`, 
           hakemYetenekleri,
           typeof hakemYetenekleri, 
           Array.isArray(hakemYetenekleri) ? 'Array': 'Not Array');
        
        // Yetenekleri i≈ülemek i√ßin
        let expertiseArray = [];
        try {
          if (hakemYetenekleri) {
            if (typeof hakemYetenekleri === 'string') {
              // String olarak gelmi≈ü olabilir, JSON parse deneyelim
              console.log(`${reviewer.ad} i√ßin JSON string:`, hakemYetenekleri);
              
              try {
                expertiseArray = JSON.parse(hakemYetenekleri);
                console.log(`${reviewer.ad} i√ßin JSON.parse sonrasƒ± yetenekler:`, expertiseArray);
              } catch (parseError) {
                // JSON parse ba≈üarƒ±sƒ±z olursa, virg√ºlle ayƒ±rma deneyelim
                console.warn(`${reviewer.ad} i√ßin JSON parse hatasƒ±, virg√ºlle ayrƒ±lmƒ±≈ü olabilir:`, parseError);
                expertiseArray = hakemYetenekleri.split(',').map(item => item.trim());
                console.log(`${reviewer.ad} i√ßin virg√ºlle ayrƒ±lmƒ±≈ü yetenekler:`, expertiseArray);
              }
            } else if (Array.isArray(hakemYetenekleri)) {
              // Zaten dizi ise doƒürudan kullan
              expertiseArray = hakemYetenekleri;
              console.log(`${reviewer.ad} i√ßin array yetenekler:`, expertiseArray);
            } else if (typeof hakemYetenekleri === 'object') {
              // Eƒüer bir obje ise i√ßindeki deƒüerleri alƒ±p diziye d√∂n√º≈üt√ºrelim
              expertiseArray = Object.values(hakemYetenekleri);
              console.log(`${reviewer.ad} i√ßin object yetenekler:`, expertiseArray);
            }
            
            // Eƒüer hala bo≈ü geliyorsa, direk string olarak vermeyi deneyelim
            if (expertiseArray.length === 0 && hakemYetenekleri) {
              expertiseArray = [String(hakemYetenekleri)];
              console.log(`${reviewer.ad} i√ßin string olarak yetenekler:`, expertiseArray);
            }
          } else {
            console.warn(`${reviewer.ad} ${reviewer.soyad} i√ßin yetenekler bulunamadƒ±`);
          }
        } catch (e) {
          console.error(`${reviewer.ad} i√ßin hakem yetenekleri i≈üleme hatasƒ±:`, e);
          expertiseArray = [];
        }
        
        // API yanƒ±tƒ± hakkƒ±nda daha detaylƒ± bilgi
        console.log(`${reviewer.ad} ${reviewer.soyad} i≈ülenmi≈ü yetenekler (${expertiseArray.length}):`, expertiseArray);
        
        return {
          id: reviewer.id,
          name: `${reviewer.unvan || ''} ${reviewer.ad} ${reviewer.soyad}`.trim(),
          email: reviewer.eposta,
          expertise: expertiseArray
        };
      }).filter(Boolean) as Array<{id: number, name: string, email: string, expertise?: string[]}>; // null deƒüerleri filtrele
      
      // Her bir hakem i√ßin uzmanlƒ±k bilgilerini logla
      reviewerNames.forEach(reviewer => {
        console.log(`ƒ∞≈ülenmi≈ü Hakem: ${reviewer.name}, Uzmanlƒ±k alanlarƒ± (${reviewer.expertise?.length || 0}):`, reviewer.expertise);
      });
      
      if (reviewerNames.length === 0) {
        console.warn('‚ö†Ô∏è Filtreleme sonrasƒ± hi√ß hakem bulunamadƒ±. Ad/soyad deƒüerleri eksik olabilir.');
        setMessage({
          type: 'error',
          text: 'Hakem bilgileri eksik veya hatalƒ± formatta. L√ºtfen kullanƒ±cƒ± bilgilerini kontrol edin.'
        });
      } else {
        console.log('‚úÖ ƒ∞≈ülenen hakem verileri:', reviewerNames);
      }
      
      // Hem isim listesini hem de detaylƒ± bilgiyi saklayalƒ±m
      setReviewers(reviewerNames.map(r => r.name));
      setReviewerInfo(reviewerNames);
      
      console.log('üìù Hakem sayƒ±sƒ±:', reviewerNames.length);
    } catch (error: any) {
      console.error('‚ùå Hakem verileri alƒ±namadƒ±:', error);
      
      // Hata mesajƒ±nƒ± g√∂r√ºnt√ºle
      setMessage({
        type: 'error',
        text: `Hakemler y√ºklenirken bir hata olu≈ütu. Detaylƒ± hata: ${error.message}`
      });
      
      // Bo≈ü diziler ile devam et (uygulamanƒ±n √ßalƒ±≈ümaya devam etmesi i√ßin)
      setReviewers([]);
      setReviewerInfo([]);
    } finally {
      setLoading(false);
    }
  };

  // Bildirileri getir
  const fetchPapers = async (sempozyumId?: number) => {
    setLoading(true);
    try {
      // T√ºm bildirileri getir
      const allPapers = await bildiriService.getAll();
      
      // Bildiri konularƒ±nƒ± getir (kategori adlarƒ±nƒ± g√∂stermek i√ßin)
      const bildiriKonulari = await getBildiriKonulari();
      console.log('Bildiri konularƒ±:', bildiriKonulari);
      
      // Bildiri konularƒ± i√ßin bir √∂nbellek (lookup map) olu≈ütur - daha hƒ±zlƒ± e≈üle≈ütirme i√ßin
      const bildiriKonulariMap = new Map();
      bildiriKonulari.forEach((konu: any) => {
        bildiriKonulariMap.set(Number(konu.bildiriKonusuId), konu);
      });
      
      // ƒ∞lk bildirinin detaylarƒ±nƒ± log olarak g√∂ster
      if (allPapers.length > 0) {
        console.log('ƒ∞lk bildiri detaylarƒ±:', {
          bildiriKonusuId: allPapers[0].bildiriKonusuId,
          bildiriKonusu: allPapers[0].bildiriKonusu,
          type: typeof allPapers[0].bildiriKonusuId
        });
        if (bildiriKonulari.length > 0) {
          console.log('ƒ∞lk bildiri kategorisi bildiriKonusuId:', bildiriKonulari[0].bildiriKonusuId, 'type:', typeof bildiriKonulari[0].bildiriKonusuId);
        }
      }
      
      // Aktif sempozyuma ait bildirileri filtrele
      let filteredPapers = allPapers;
      if (sempozyumId) {
        // Sempozyum bilgilerini getir
        const sempozyumlar = await sempozyumService.getAllSempozyumlar();
        // Aktif sempozyum adƒ±nƒ± bul
        const activeSempozyum = sempozyumlar.find(s => s.id === sempozyumId);
        const activeSempozyumTitle = activeSempozyum?.title;
        
        filteredPapers = allPapers.filter(bildiri => {
          // Bildiri sempozyum objesinde id yok, title ile kar≈üƒ±la≈ütƒ±rma yapƒ±yoruz
          return bildiri.sempozyum && bildiri.sempozyum.title === activeSempozyumTitle;
        });
        
        console.log(`Aktif sempozyum (${activeSempozyumTitle}) i√ßin ${filteredPapers.length} bildiri filtrelendi.`);
      }
      
      // Bildiri verilerini frontend formatƒ±na d√∂n√º≈üt√ºr
      const formattedPapers = filteredPapers.map(bildiri => {
        // Hakemler alanƒ±nƒ± doƒüru ≈üekilde i≈üle (JSON string'den d√∂n√º≈üt√ºr)
        let hakemlerArray = [];
        if (bildiri.hakemler) {
          try {
            // Eƒüer hakemler JSON string ise parse et
            if (typeof bildiri.hakemler === 'string') {
              hakemlerArray = JSON.parse(bildiri.hakemler);
            } 
            // Eƒüer zaten dizi ise doƒürudan kullan
            else if (Array.isArray(bildiri.hakemler)) {
              hakemlerArray = bildiri.hakemler;
            }
          } catch (e) {
            console.error('Hakemler parse edilirken hata:', e);
            hakemlerArray = [];
          }
        }

        // Bildiri konusunun adƒ±nƒ± bul - lookup map kullan
        const bildiriKonusuId = Number(bildiri.bildiriKonusuId);
        
        // √ñnce bildiri objesindeki bildiriKonusu property'sini kontrol et
        let bildiriKonusuTitle = '';
        
        // API'den gelen nesnede bildiriKonusu objesi varsa ve baslik i√ßeriyorsa direkt kullan
        if (bildiri.bildiriKonusu && bildiri.bildiriKonusu.baslik) {
          bildiriKonusuTitle = bildiri.bildiriKonusu.baslik;
          console.log('Bildiri konusu direkt objeden alƒ±ndƒ±:', bildiriKonusuTitle);
        } else {
          // Yoksa Map'ten bulmaya √ßalƒ±≈ü
          const bildiriKonusu = bildiriKonulariMap.get(bildiriKonusuId);
          
          // Eƒüer bildiri konusu bulunamadƒ±ysa detaylarƒ± logla
          if (!bildiriKonusu) {
            console.log('Bildiri konusu bulunamadƒ±:', bildiriKonusuId);
            console.log('Mevcut bildiri konularƒ± IDs:', Array.from(bildiriKonulariMap.keys()));
            bildiriKonusuTitle = bildiri.bildiriKonusuId?.toString() || '';
          } else {
            bildiriKonusuTitle = bildiriKonusu.title;
          }
        }
        
        return {
          id: bildiri.id.toString(),
          title: bildiri.baslik,
          authors: bildiri.yazarlar || [],
          abstract: bildiri.ozet,
          paperTopicId: bildiri.bildiriKonusuId?.toString() || '',
          paperTopicTitle: bildiriKonusuTitle, // Kategori adƒ±nƒ± da ekleyelim
          mainTopicId: bildiri.anaKonuId?.toString() || '',
          status: bildiri.durum || 'pending',
          submissionDate: new Date(bildiri.createdAt).toLocaleDateString('tr-TR'),
          hakemIds: hakemlerArray, // Hakem ID'lerini sakla
          reviewers: [], // Bo≈ü dizi olarak ba≈ülat, sonra dolduracaƒüƒ±z
          dokuman: bildiri.dokuman // PDF dosyasƒ±nƒ±n URL'i
        };
      });
      
      // Hakem ID'lerine g√∂re hakem bilgilerini getir
      if (formattedPapers.length > 0) {
        try {
          // B√ºt√ºn hakem ID'lerini topla
          const allHakemIds = formattedPapers.flatMap(paper => paper.hakemIds || []);
          
          if (allHakemIds.length > 0) {
            // Hakem bilgilerini getir
            const hakemler = await userService.getReviewers();
            
            // Her bildiri i√ßin hakem bilgilerini e≈üle≈ütir
            formattedPapers.forEach(paper => {
              if (paper.hakemIds && paper.hakemIds.length > 0) {
                paper.reviewers = paper.hakemIds.map((hakemId: number) => {
                  const hakem = hakemler.find(h => h.id === hakemId);
                  return hakem ? `${hakem.unvan || ''} ${hakem.ad} ${hakem.soyad}`.trim() : `Hakem #${hakemId}`;
                });
              }
            });
          }
        } catch (error) {
          console.error('Hakem bilgileri getirilirken hata:', error);
        }
      }
      
      setPapers(formattedPapers);
      console.log('Bildiriler ba≈üarƒ±yla y√ºklendi:', formattedPapers);
    } catch (error) {
      console.error('Bildiriler getirilirken hata:', error);
      setMessage({ 
        type: 'error', 
        text: 'Bildiriler y√ºklenirken bir hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin.' 
      });
    } finally {
      setLoading(false);
    }
  };
  
  // Bildirileri filtrele - searchTerm, selectedStatus ve selectedCategory deƒüi≈üikliklerini izle
  // useEffect kullanarak bu deƒüi≈üiklikleri dinleyelim
  useEffect(() => {
    // Bildirileri filtrele - bo≈ü kontrol ko≈üulunu kaldƒ±rdƒ±k
    const newFilteredPapers = papers.filter(currentPaper => {
      const matchesSearch = 
        currentPaper.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
        currentPaper.authors.some(author => author.toLowerCase().includes(searchTerm.toLowerCase()));
      
      const matchesStatus = selectedStatus === '' || currentPaper.status === selectedStatus;
      const matchesCategory = selectedCategory === '' || currentPaper.paperTopicId === selectedCategory;
      
      return matchesSearch && matchesStatus && matchesCategory;
    });

    // Sadece bo≈ü olmayan papers i√ßin debug log
    if (papers.length > 0) {
      console.log(`Filtreleme: ${papers.length} bildiriden ${newFilteredPapers.length} bildiri filtrelendi`);
      console.log(`Filtreler: Arama=${searchTerm}, Durum=${selectedStatus}, Kategori=${selectedCategory}`);
    }
  }, [searchTerm, selectedStatus, selectedCategory, papers]);

  // Bildirileri filtrele
  const filteredPapers = papers.filter(paper => {
    const matchesSearch = 
      paper.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
      paper.authors.some(author => author.toLowerCase().includes(searchTerm.toLowerCase()));
    
    const matchesStatus = selectedStatus === '' || paper.status === selectedStatus;
    const matchesCategory = selectedCategory === '' || paper.paperTopicId === selectedCategory;
    
    return matchesSearch && matchesStatus && matchesCategory;
  });
  
  // Kategorileri √ßƒ±kar - her kategori yalnƒ±zca bir kez g√∂sterilsin
  const uniqueCategories = papers.reduce((acc, paper) => {
    // Eƒüer bu kategori daha √∂nce eklenmemi≈üse ekle
    if (!acc.some(cat => cat.id === paper.paperTopicId)) {
      acc.push({ id: paper.paperTopicId, title: paper.paperTopicTitle });
    }
    return acc;
  }, [] as { id: string, title: string }[]);
  
  // Kategorileri alfabetik olarak sƒ±rala
  const categories = uniqueCategories.sort((a, b) => a.title.localeCompare(b.title));
  
  // Mevcut durumlarƒ± √ßƒ±kar - sadece mevcut bildiri durumlarƒ±nƒ± g√∂ster
  const availableStatuses = papers.reduce((acc, paper) => {
    const status = paper.status;
    if (!acc.includes(status)) {
      acc.push(status);
    }
    return acc;
  }, [] as string[]);
  
  // Durum g√∂sterimini √ßevirecek yardƒ±mcƒ± fonksiyon ekleyelim
  const getStatusDisplay = (status: string) => {
    // Arka u√ßtan gelen durum deƒüerlerini T√ºrk√ße kar≈üƒ±lƒ±klarƒ±na √ßeviriyoruz
    switch (status) {
      case 'accepted':
      case 'kabul_edildi':
        return { text: 'Kabul Edildi', classes: 'bg-green-100 text-green-800' };
      case 'rejected':
      case 'reddedildi':
        return { text: 'Reddedildi', classes: 'bg-red-100 text-red-800' };
      case 'under-review':
      case 'under_review':
      case 'incelemede':
        return { text: 'ƒ∞ncelemede', classes: 'bg-blue-100 text-blue-800' };
      case 'revision_requested':
      case 'revizyon_istendi':
      case 'revision-needed':
      case 'revizyon_gerekli': 
        return { text: 'Revizyon ƒ∞stendi', classes: 'bg-yellow-100 text-yellow-800' };
      case 'REVIZE_YAPILDI':
      case 'revize_yapildi':
        return { text: 'Revize Yapƒ±ldƒ±', classes: 'bg-purple-100 text-purple-800' };
      case 'pending':
      case 'beklemede':
        return { text: 'Beklemede', classes: 'bg-gray-100 text-gray-800' };
      case 'published':
      case 'yayinlandi':
        return { text: 'Yayƒ±nlandƒ±', classes: 'bg-indigo-100 text-indigo-800' };
      default:
        return { text: status, classes: 'bg-gray-100 text-gray-800' };
    }
  };

  // Hakem atama modalƒ±nƒ± a√ß
  const openReviewerModal = (paper: Paper) => {
    setSelectedPaper(paper);
    const currentReviewers = paper.reviewers || [];
    setSelectedReviewers(currentReviewers);
    setReviewerSearchTerm(''); // Arama terimini sƒ±fƒ±rla
    
    // Eƒüer reviewerInfo bo≈üsa, uyarƒ± mesajƒ± g√∂ster
    if (reviewerInfo.length === 0) {
      console.warn('Hakem bilgileri bulunamadƒ± - Kullanƒ±cƒ±ya bildiri g√∂sterilecek');
      setMessage({
        type: 'error',
        text: 'Sistemde kayƒ±tlƒ± hakem bulunamadƒ±. L√ºtfen √∂nce hakem ekleyin.'
      });
      // Bo≈ü hakem listelerini ayarla
      setReviewers([]);
      setReviewerInfo([]);
      setAvailableReviewers([]);
    } else {
      // Mevcut reviewerInfo kullanarak kullanƒ±labilir hakemleri belirle
      const allReviewerNames = reviewerInfo.map(r => r.name);
      
      // Se√ßilmemi≈ü olan hakemleri g√∂ster
      const notAssignedReviewers = allReviewerNames.filter(
        name => !currentReviewers.includes(name)
      );
      
      // Kullanƒ±labilir hakemleri ayarla
      setAvailableReviewers(notAssignedReviewers);
      
      console.log('Mevcut hakemler:', currentReviewers);
      console.log('T√ºm hakemler:', allReviewerNames);
      console.log('Se√ßilebilir hakemler:', notAssignedReviewers);
    }
    
    setIsReviewerModalOpen(true);
  };
  
  // Hakem atama modalƒ±nƒ± kapat
  const closeReviewerModal = () => {
    setIsReviewerModalOpen(false);
    setSelectedPaper(null);
    setSelectedReviewers([]);
  };

  // Anlƒ±k bildiri g√ºncellemesi i√ßin yardƒ±mcƒ± fonksiyon
  const updatePaperReviewers = (paperId: string, selectedReviewerNames: string[]) => {
    setPapers(prevPapers => 
      prevPapers.map(paper => {
        if (paper.id === paperId) {
          // Sadece se√ßili bildirideki hakem listesini g√ºncelle
          return { 
            ...paper, 
            reviewers: [...selectedReviewerNames] 
          };
        }
        return paper;
      })
    );
  };
  
  // Hakem se√ßimini deƒüi≈ütir
  const toggleReviewer = (reviewer: string) => {
    if (selectedReviewers.includes(reviewer)) {
      // Hakem zaten se√ßili, √ßƒ±kart
      const updatedReviewers = selectedReviewers.filter(r => r !== reviewer);
      setSelectedReviewers(updatedReviewers);
      
      // √áƒ±kartƒ±lan hakemi availableReviewers listesine ekle (eƒüer yoksa)
      if (!availableReviewers.includes(reviewer)) {
        setAvailableReviewers(prev => [...prev, reviewer]);
      }

      // Eƒüer se√ßili bildiri varsa, anlƒ±k olarak UI'daki hakem listesini de g√ºncelle
      if (selectedPaper) {
        updatePaperReviewers(selectedPaper.id, updatedReviewers);
      }
    } else {
      // Hakem se√ßili deƒüil, ekle
      const updatedReviewers = [...selectedReviewers, reviewer];
      setSelectedReviewers(updatedReviewers);
      
      // Eklenen hakemi availableReviewers listesinden √ßƒ±kart
      setAvailableReviewers(prev => prev.filter(r => r !== reviewer));

      // Eƒüer se√ßili bildiri varsa, anlƒ±k olarak UI'daki hakem listesini de g√ºncelle
      if (selectedPaper) {
        updatePaperReviewers(selectedPaper.id, updatedReviewers);
      }
    }
  };
  
  // Hakem atamalarƒ±nƒ± kaydet
  const saveReviewerAssignment = async () => {
    try {
      if (!selectedPaper) {
        console.error('Se√ßili bildiri bulunamadƒ±.');
        return;
      }
      
      console.log('Se√ßili hakemler:', selectedReviewers);
      
      // Hakem ID'lerini bulmak i√ßin reviewerInfo array'ini kullan
      const selectedHakemIds = selectedReviewers.map(reviewerName => {
        const reviewer = reviewerInfo.find(r => r.name === reviewerName);
        return reviewer ? reviewer.id : null;
      }).filter(id => id !== null) as number[]; // null deƒüerleri filtrele
      
      console.log('Atanacak hakem ID\'leri:', selectedHakemIds);
      
      // bildiriService.assignReviewers kullan
      const result = await bildiriService.assignReviewers(parseInt(selectedPaper.id), selectedHakemIds);
      
      if (!result.success) {
        throw new Error(result.error || 'Hakem atama i≈ülemi ba≈üarƒ±sƒ±z oldu.');
      }
      
      console.log('Hakem atama sonucu:', result);

      // Veritabanƒ± g√ºncellemesi sonrasƒ± aktif sempozyuma ait bildirileri getir
      if (aktifSempozyumId) {
        await fetchPapers(aktifSempozyumId);
      } else {
        // Aktif sempozyum yoksa, normal fetchPapers √ßaƒüƒ±r
        await fetchPapers();
      }

      // Ba≈üarƒ± mesajƒ±nƒ± g√∂ster
      setMessage({ 
        type: 'success', 
        text: selectedHakemIds.length > 0 ? 'Hakem atamasƒ± ba≈üarƒ±yla g√ºncellendi.' : 'T√ºm hakemler ba≈üarƒ±yla kaldƒ±rƒ±ldƒ±.'
      });
      
      // Modalƒ± kapat
      closeReviewerModal();
      
      // Mesajƒ± 3 saniye sonra temizle
      setTimeout(() => {
        setMessage({ type: '', text: '' });
      }, 3000);
    } catch (error) {
      console.error('Hakem atamasƒ± yapƒ±lƒ±rken hata:', error);
      setMessage({ 
        type: 'error', 
        text: 'Hakem atamasƒ± yapƒ±lƒ±rken bir hata olu≈ütu. L√ºtfen tekrar deneyin.' 
      });
    }
  };
  
  // Hakem Modalƒ±
  const HakemModal = () => {
    // Modalƒ±n i√ßinde useEffect ile t√ºm hakemler i√ßin expertise bilgisi konsola yazdƒ±ralƒ±m
    React.useEffect(() => {
      if (reviewerInfo.length > 0) {
        console.log('üü¢üü¢üü¢ HAKEM MODAL A√áILDI - T√úM HAKEM Lƒ∞STESƒ∞ üü¢üü¢üü¢');
        reviewerInfo.forEach(reviewer => {
          console.log(`Hakem: ${reviewer.name}, ID: ${reviewer.id}`);
          console.log(`  Expertise Deƒüeri:`, reviewer.expertise);
          console.log(`----------------------------------------`);
        });
      }
    }, []);

    // Arama terimine g√∂re filtrelenmi≈ü hakemler listesi
    const filteredAvailableReviewers = availableReviewers.filter(
      reviewer => reviewer.toLowerCase().includes(reviewerSearchTerm.toLowerCase())
    );

    // Hakem arama i≈ülemini y√∂net
    const handleReviewerSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
      const searchValue = e.target.value;
      setReviewerSearchTerm(searchValue);
    };

    // Input i√ßin referans olu≈ütur
    const searchInputRef = React.useRef<HTMLInputElement>(null);

    // Modal a√ßƒ±ldƒ±ƒüƒ±nda search inputuna otomatik focus saƒüla
    React.useEffect(() => {
      // Timeout kullanarak DOM'un hazƒ±r olmasƒ±nƒ± bekle
      const focusTimeout = setTimeout(() => {
        if (searchInputRef.current) {
          searchInputRef.current.focus();
        }
      }, 100);
      
      return () => clearTimeout(focusTimeout);
    }, []);

    // Hakem bilgisini hazƒ±rlayan yardƒ±mcƒ± fonksiyon
    const prepareExpertiseInfo = (reviewerName: string) => {
      const reviewer = reviewerInfo.find(r => r.name === reviewerName);
      if (!reviewer) return { expertise: [] };

      // Expertise bilgisini hazƒ±rlayalƒ±m
      const isExpertiseArray = Array.isArray(reviewer.expertise);
      let expertise = [];

      try {
        if (reviewer.expertise) {
          if (isExpertiseArray) {
            expertise = reviewer.expertise;
          } else if (typeof reviewer.expertise === 'string') {
            try {
              // TypeScript hatasƒ± burada - string[] as string olarak cast edilemiyor
              // as unknown ekleyerek d√ºzeltelim
              expertise = JSON.parse(reviewer.expertise as unknown as string);
            } catch (e) {
              expertise = [reviewer.expertise as unknown as string];
            }
          } else if (typeof reviewer.expertise === 'object' && reviewer.expertise !== null) {
            expertise = Object.values(reviewer.expertise);
          } else {
            expertise = [String(reviewer.expertise)];
          }
        }
      } catch (e) {
        console.error("Expertise hazƒ±rlama hatasƒ±:", e);
        expertise = [];
      }

      return { expertise };
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 overflow-hidden">
          <div className="px-6 py-4 border-b border-gray-200">
            <h3 className="text-lg font-semibold text-gray-900">Hakem Ata</h3>
          </div>
          
          <div className="px-6 py-4">
            <div className="mb-4">
              <h4 className="font-medium text-gray-900 mb-2">Bildiri Bilgileri:</h4>
              <p className="text-gray-700">{selectedPaper?.title}</p>
              <p className="text-sm text-gray-500">Yazar: {selectedPaper?.authors.join(', ')}</p>
            </div>
            
            <div className="mb-4">
              <h4 className="font-medium text-gray-900 mb-2">Mevcut Hakemler:</h4>
              {selectedReviewers && selectedReviewers.length > 0 ? (
                <div className="space-y-2">
                  {selectedReviewers.map((reviewer: string, index: number) => {
                    // Expertise bilgisini hazƒ±rla
                    const { expertise } = prepareExpertiseInfo(reviewer);

                    return (
                      <div key={index} className="flex items-start justify-between bg-blue-50 p-3 rounded">
                        <div className="flex-1">
                          <div className="font-medium">{reviewer}</div>
                          {expertise && expertise.length > 0 ? (
                            <div className="mt-2 text-xs">
                              <span className="font-medium text-gray-600 block mb-1">Uzmanlƒ±k Alanlarƒ±:</span>
                              <div className="flex flex-wrap gap-1">
                                {expertise.map((exp: any, i: number) => (
                                  <span key={i} className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    {typeof exp === 'object' ? JSON.stringify(exp) : String(exp)}
                                  </span>
                                ))}
                              </div>
                            </div>
                          ) : (
                            <div className="mt-1 text-xs italic text-gray-500">Uzmanlƒ±k alanƒ± belirtilmemi≈ü</div>
                          )}
                        </div>
                        <button 
                          onClick={() => toggleReviewer(reviewer)}
                          className="text-red-600 hover:text-red-800 ml-2 mt-1"
                        >
                          <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                          </svg>
                        </button>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <p className="text-gray-500 italic">Hen√ºz hakem atanmamƒ±≈ü.</p>
              )}
            </div>
            
            <div>
              <h4 className="font-medium text-gray-900 mb-2">
                {reviewerInfo.length === 0 ? "Hakem Durumu" : "Hakem Ekle:"}
              </h4>
              
              {/* Hakem Arama */}
              <div className="mb-3">
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg className="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                  </div>
                  <input
                    ref={searchInputRef}
                    type="text"
                    className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Hakem adƒ±na g√∂re ara..."
                    value={reviewerSearchTerm}
                    onChange={handleReviewerSearch}
                    onClick={(e) => e.currentTarget.focus()}
                    autoFocus={true}
                  />
                </div>
              </div>
              
              <div className="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
                {filteredAvailableReviewers.length > 0 ? (
                  <div className="divide-y divide-gray-200">
                    {filteredAvailableReviewers.map((reviewer, index) => {
                      // Expertise bilgisini hazƒ±rla
                      const { expertise } = prepareExpertiseInfo(reviewer);
                      
                      return (
                        <div 
                          key={index} 
                          className="p-3 hover:bg-gray-50 cursor-pointer flex items-start"
                          onClick={() => toggleReviewer(reviewer)}
                        >
                          <input 
                            type="checkbox" 
                            checked={selectedReviewers.includes(reviewer)}
                            onChange={() => {}}
                            className="h-4 w-4 text-blue-600 border-gray-300 rounded mr-3 mt-1"
                          />
                          <div className="flex-1">
                            <div className="font-medium">{reviewer}</div>
                            {expertise && expertise.length > 0 ? (
                              <div className="mt-1 text-xs">
                                <span className="font-medium text-gray-600">Uzmanlƒ±k Alanlarƒ±:</span>
                                <div className="flex flex-wrap gap-1 mt-1">
                                  {expertise.map((exp: any, i: number) => (
                                    <span key={i} className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                      {typeof exp === 'object' ? JSON.stringify(exp) : String(exp)}
                                    </span>
                                  ))}
                                </div>
                              </div>
                            ) : (
                              <div className="mt-1 text-xs italic text-gray-500">Uzmanlƒ±k alanƒ± belirtilmemi≈ü</div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : reviewerSearchTerm ? (
                  <p className="p-3 text-gray-500 italic">Arama kriterine uygun hakem bulunamadƒ±.</p>
                ) : reviewerInfo.length === 0 ? (
                  <div className="p-3">
                    <p className="text-red-500 font-medium mb-1">Sistemde kayƒ±tlƒ± hakem bulunamadƒ±!</p>
                    <p className="text-gray-500 text-sm">L√ºtfen √∂nce sisteme hakem ekleyin.</p>
                  </div>
                ) : (
                  <p className="p-3 text-gray-500 italic">T√ºm hakemler zaten bu bildiriye atanmƒ±≈ü.</p>
                )}
              </div>
            </div>
          </div>
          
          <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
            <button
              onClick={closeReviewerModal}
              className="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-50 transition-colors"
            >
              ƒ∞ptal
            </button>
            <button
              onClick={saveReviewerAssignment}
              className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
            >
              Kaydet
            </button>
          </div>
        </div>
      </div>
    );
  };

  // √ñnizleme modalƒ±nƒ± a√ßmadan √∂nce revizyon detaylarƒ±nƒ± y√ºkle
  const handlePreviewPaper = async (paper: Paper) => {
    setPreviewPaper(paper);
    setIsPreviewModalOpen(true);
    
    // T√ºm bildiriler i√ßin deƒüerlendirme detaylarƒ±nƒ± y√ºkle
    try {
      setRevizyonYukleniyor(true);
      setRevizyonDetaylari([]); // Y√ºkleme ba≈üladƒ±ƒüƒ±nda mevcut verileri temizle
      
      // RevizeGecmisi tablosundan verileri √ßek
      const revizeGecmisiListesi = await revizeGecmisiService.getByBildiriId(parseInt(paper.id));
      console.log('Bildiriye ait revize ge√ßmi≈üi detaylarƒ± (Ham):', JSON.stringify(revizeGecmisiListesi));
      
      // API'den bir veri geldi mi kontrol et
      if (!revizeGecmisiListesi || !Array.isArray(revizeGecmisiListesi)) {
        console.error('Revize ge√ßmi≈üi listesi ge√ßerli bir dizi deƒüil:', revizeGecmisiListesi);
        setRevizyonDetaylari([]);
        return;
      }
      
      // API'den d√∂nen alanlarƒ± kontrol et ve log bilgisi yaz
      if (revizeGecmisiListesi.length > 0) {
        console.log('ƒ∞lk revize ge√ßmi≈üi kaydƒ±nƒ±n t√ºm alanlarƒ±:', Object.keys(revizeGecmisiListesi[0]));
        console.log('√ñrnek revize ge√ßmi≈üi verisi:', JSON.stringify(revizeGecmisiListesi[0], null, 2));
        
        // Deƒüerlendirmeleri tarihe g√∂re sƒ±rala (en yenisi en √ºstte)
        const siraliRevizeler = [...revizeGecmisiListesi].sort((a, b) => {
          // √ñnce revizeTarihi alanƒ± varsa onu kullan, yoksa createdAt
          const dateA = a.revizeTarihi ? new Date(a.revizeTarihi).getTime() : new Date(a.createdAt || '').getTime();
          const dateB = b.revizeTarihi ? new Date(b.revizeTarihi).getTime() : new Date(b.createdAt || '').getTime();
          return dateB - dateA; // En yeniden en eskiye
        });
        
        // Hakem isimlerini ekleyerek deƒüerlendirme detaylarƒ±nƒ± olu≈ütur
        const detayliRevizeler = await Promise.all(siraliRevizeler.map(async (revize) => {
          // Hakem adƒ±nƒ± bul
          let hakemAdi = "";
          if (revize.hakemId) {
            const hakem = reviewerInfo.find(r => r.id === revize.hakemId);
            hakemAdi = hakem ? hakem.name : `Hakem #${revize.hakemId}`;
          } else {
            hakemAdi = "Bilinmeyen Hakem";
          }
          
          // T√ºm alanlarƒ±, hem mevcut hem de yeni eklenenler dahil olmak √ºzere kopyala
          return {
            ...revize,
            id: revize.id || Math.random(), // ID yoksa random ID ata (UI i√ßin gerekli)
            hakemAdi,
            hakemId: revize.hakemId || 0,
            durum: (revize.durum || 'REVIZE').toUpperCase(), // Durum yoksa default deƒüer ata ve b√ºy√ºk harfe √ßevir
            // Yeni alanlar i√ßin null veya undefined kontrol√º
            gucluYonler: revize.gucluYonler || '',
            zayifYonler: revize.zayifYonler || '',
            genelYorum: revize.genelYorum || '',
            guvenSeviyesi: revize.guvenSeviyesi || 0,
            makaleTuru: revize.makaleTuru || '',
            makaleBasligi: revize.makaleBasligi || '',
            soyut: revize.soyut || '',
            anahtarKelimeler: revize.anahtarKelimeler || '',
            giris: revize.giris || '',
            gerekcelerVeYontemler: revize.gerekcelerVeYontemler || '',
            sonuclarVeTartismalar: revize.sonuclarVeTartismalar || '',
            referanslar: revize.referanslar || '',
            guncellikVeOzgunluk: revize.guncellikVeOzgunluk || '',
            createdAt: revize.createdAt || new Date().toISOString(),
            updatedAt: revize.updatedAt || new Date().toISOString(),
            revizeTarihi: revize.revizeTarihi || revize.createdAt || new Date().toISOString(),
            sempozyumId: revize.sempozyumId,
            bildiriId: revize.bildiriId
          };
        }));
        
        console.log('ƒ∞≈ülenmi≈ü revize ge√ßmi≈üi detaylarƒ±:', detayliRevizeler);
        setRevizyonDetaylari(detayliRevizeler);
      } else {
        console.log('Bildiri i√ßin revize ge√ßmi≈üi bulunamadƒ±');
        setRevizyonDetaylari([]);
      }
    } catch (error) {
      console.error('Revize ge√ßmi≈üi detaylarƒ± y√ºklenirken hata:', error);
      setRevizyonDetaylari([]);
    } finally {
      setRevizyonYukleniyor(false);
    }
  };

  // Admin olmayan kullanƒ±cƒ±lar i√ßin y√ºkleme ekranƒ±
  if (!user || !isAdmin || loading) {
    return (
      <div className="min-h-screen bg-white py-12 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700 mx-auto mb-4"></div>
          <p className="text-gray-600">Y√ºkleniyor...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-12">
      <div className="container mx-auto px-4">
        <div className="max-w-6xl mx-auto">
          <div className="flex justify-between items-center mb-8">
            <h1 className="text-3xl font-bold text-gray-800">Bildiri Y√∂netimi</h1>
            <div className="flex space-x-2">
              <Link 
                href="/admin/dashboard" 
                className="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition duration-200"
              >
                Dashboard'a D√∂n
              </Link>
            </div>
          </div>
          
          {/* Ba≈üarƒ±/Hata Mesajƒ± */}
          {message.text && (
            <div className={`mb-6 p-4 rounded-md ${message.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
              {message.text}
            </div>
          )}
          
          {/* Arama ve Filtreleme */}
          <div className="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-8">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label htmlFor="search" className="block text-sm font-medium text-gray-700 mb-1">Bildiri Ara</label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg className="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                  </div>
                  <input
                    type="text"
                    id="search"
                    className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Ba≈ülƒ±k veya yazar ile ara..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                  />
                </div>
              </div>
              <div>
                <label htmlFor="category" className="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                <select
                  id="category"
                  className="block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  value={selectedCategory}
                  onChange={(e) => setSelectedCategory(e.target.value)}
                >
                  <option value="">T√ºm Kategoriler</option>
                  {categories.map((category, index) => (
                    <option key={index} value={category.id}>{category.title}</option>
                  ))}
                </select>
              </div>
              <div>
                <label htmlFor="status" className="block text-sm font-medium text-gray-700 mb-1">Durum</label>
                <select
                  id="status"
                  className="block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  value={selectedStatus}
                  onChange={(e) => setSelectedStatus(e.target.value)}
                >
                  <option value="">T√ºm Durumlar</option>
                  {availableStatuses.map((status, index) => (
                    <option key={index} value={status}>{getStatusDisplay(status).text}</option>
                  ))}
                </select>
              </div>
            </div>
            <div className="mt-4 flex justify-end">
              <button 
                className="bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 rounded-lg transition duration-200"
                onClick={() => {
                  // Filtreleri uygula butonu tƒ±klandƒ±ƒüƒ±nda otomatik olarak filtreleme yapar
                  // Bu fonksiyon bo≈ü olabilir √ß√ºnk√º filtreleme zaten otomatik olarak yapƒ±lƒ±yor
                  // Ancak kullanƒ±cƒ±ya g√∂rsel olarak bir geri bildirim vermek iyi olur
                  setMessage({ type: 'success', text: 'Filtreler uygulandƒ±' });
                  
                  // 2 saniye sonra mesajƒ± temizle
                  setTimeout(() => {
                    setMessage({ type: '', text: '' });
                  }, 2000);
                }}
              >
                Filtreleri Uygula
              </button>
            </div>
          </div>
          
          {/* Bildiri Tablosu */}
          <div className="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Bildiri
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Kategori
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Durum
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Hakemler
                    </th>
                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      ƒ∞≈ülemler
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {filteredPapers.map((paper) => (
                    <tr key={paper.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4">
                        <div>
                          <div className="text-sm font-medium text-gray-900">{paper.title}</div>
                          <div className="text-sm text-gray-500">
                            <span className="font-medium">Yazar:</span> {paper.authors.join(', ')}
                          </div>
                          <div className="text-xs text-gray-500">
                            <span className="font-medium">G√∂nderim:</span> {paper.submissionDate}
                          </div>
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                          {paper.paperTopicTitle}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusDisplay(paper.status).classes}`}>
                          {getStatusDisplay(paper.status).text}
                        </span>
                      </td>
                      <td className="px-6 py-4">
                        <div className="text-sm text-gray-500">
                          {paper.reviewers?.map((reviewer, index) => (
                            <div key={index} className="mb-1 last:mb-0">
                              {reviewer}
                            </div>
                          ))}
                          {(!paper.reviewers || paper.reviewers.length === 0) && (
                            <span className="text-gray-400 italic">Hakem atanmadƒ±</span>
                          )}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div className="flex justify-end space-x-2">
                          <button 
                            className="text-blue-600 hover:text-blue-900" 
                            title="G√∂r√ºnt√ºle"
                            onClick={() => handlePreviewPaper(paper)}
                          >
                            <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                          </button>
                          {paper.dokuman && (
                            <button 
                              className="text-red-600 hover:text-red-900" 
                              title="PDF G√∂r√ºnt√ºle"
                              onClick={() => {
                                window.open(paper.dokuman, '_blank');
                              }}
                            >
                              <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                              </svg>
                            </button>
                          )}
                          <button 
                            className="text-green-600 hover:text-green-900" 
                            title="Hakem Ata"
                            onClick={() => openReviewerModal(paper)}
                          >
                            <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M17 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="bg-gray-50 px-6 py-3 border-t border-gray-200 flex items-center justify-between">
              <div className="text-sm text-gray-500">
                Toplam <span className="font-medium">{filteredPapers.length}</span> bildiri
              </div>
              <div className="flex space-x-2">
                <button className="bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 px-4 py-2 rounded-lg transition duration-200 text-sm">
                  √ñnceki
                </button>
                <button className="bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 px-4 py-2 rounded-lg transition duration-200 text-sm">
                  Sonraki
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      {/* Hakem Atama Modalƒ± */}
      {isReviewerModalOpen && selectedPaper && <HakemModal />}
      
      {/* Bildiri √ñnizleme Modalƒ± */}
      {isPreviewModalOpen && previewPaper && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
              <h3 className="text-lg font-semibold text-gray-900">Bildiri Detaylarƒ±</h3>
              <button 
                onClick={() => setIsPreviewModalOpen(false)}
                className="text-gray-400 hover:text-gray-500"
              >
                <svg className="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div className="px-6 py-4 max-h-[70vh] overflow-y-auto">
              <div className="space-y-6">
                {/* Ba≈ülƒ±k ve Yazarlar */}
                <div>
                  <h2 className="text-xl font-bold text-gray-900 border-b pb-2">{previewPaper.title}</h2>
                  <div className="mt-2 flex flex-wrap gap-2">
                    {previewPaper.authors.map((author, index) => (
                      <span 
                        key={index} 
                        className="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800"
                      >
                        {author}
                      </span>
                    ))}
                  </div>
                </div>
                
                {/* Durum ve Tarih */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <span className="text-sm font-medium text-gray-500">Durum</span>
                    <div className="mt-1">
                      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusDisplay(previewPaper.status).classes}`}>
                        {getStatusDisplay(previewPaper.status).text}
                      </span>
                      <div className="mt-2 text-sm font-semibold">
                        {previewPaper.reviewers && previewPaper.reviewers.length > 0 
                          ? <span className="text-blue-600">Hakem Atandƒ±</span> 
                          : <span className="text-amber-600">Hakem Bekleniyor</span>}
                      </div>
                    </div>
                  </div>
                  <div>
                    <span className="text-sm font-medium text-gray-500">G√∂nderim Tarihi</span>
                    <p className="mt-1 text-sm font-medium text-gray-900">{previewPaper.submissionDate}</p>
                  </div>
                </div>
                
                {/* Revize Ge√ßmi≈üi */}
                <div className="mt-6">
                  <h3 className="text-lg font-medium text-gray-900 mb-3">Revize Ge√ßmi≈üi</h3>
                  
                  {revizyonYukleniyor ? (
                    <div className="py-4 text-center">
                      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-700 mx-auto"></div>
                      <p className="mt-2 text-sm text-gray-500">Deƒüerlendirme detaylarƒ± y√ºkleniyor...</p>
                    </div>
                  ) : revizyonDetaylari.length > 0 ? (
                    <div className="space-y-6">
                      {/* Deƒüerlendirme √∂zeti - sayƒ±lar ve durumlar */}
                      <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p className="font-medium text-gray-900">
                          <span className="text-blue-600">{Array.from(new Set(revizyonDetaylari.map(r => r.hakemId))).length}</span> hakem tarafƒ±ndan toplam <span className="text-blue-600">{revizyonDetaylari.length}</span> deƒüerlendirme yapƒ±lmƒ±≈ü:
                        </p>
                        <div className="flex flex-wrap gap-2 mt-2">
                          {revizyonDetaylari.some(r => r.durum === 'KABUL') && (
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                              Kabul: {revizyonDetaylari.filter(r => r.durum === 'KABUL').length}
                            </span>
                          )}
                          {revizyonDetaylari.some(r => r.durum === 'RED') && (
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                              Red: {revizyonDetaylari.filter(r => r.durum === 'RED').length}
                            </span>
                          )}
                          {revizyonDetaylari.some(r => r.durum === 'REVIZE') && (
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                              Revize: {revizyonDetaylari.filter(r => r.durum === 'REVIZE').length}
                            </span>
                          )}
                        </div>
                      </div>
                      
                      {/* Hakemlere g√∂re grupla */}
                      <div>
                        {/* Benzersiz hakem ID'lerini bul */}
                        {Array.from(new Set(revizyonDetaylari
                          .filter(r => r.hakemId !== undefined && r.hakemId !== null) // null ya da undefined olan hakem ID'lerini filtrele
                          .map(r => r.hakemId)
                        )).map(hakemId => {
                          if (!hakemId) return null;
                          
                          // Hakem adƒ±nƒ± bul
                          const ilkRevize = revizyonDetaylari.find(r => r.hakemId === hakemId);
                          const hakemAdi = ilkRevize?.hakemAdi || `Hakem #${hakemId}`;
                          
                          // Bu hakemin t√ºm deƒüerlendirmelerini bul
                          const hakemDeƒüerlendirmeleri = revizyonDetaylari
                            .filter(r => r.hakemId === hakemId)
                            .sort((a, b) => new Date(b.createdAt || '').getTime() - new Date(a.createdAt || '').getTime());
                          
                          if (hakemDeƒüerlendirmeleri.length === 0) return null;
                          
                          // Hakeme ait en g√ºncel deƒüerlendirmeyi bul
                          const sonDegerlendirme = hakemDeƒüerlendirmeleri[0];
                          
                          return (
                            <div key={hakemId} className="border border-gray-200 rounded-lg overflow-hidden mb-4">
                              <div className="bg-gray-50 px-4 py-3 flex justify-between items-center">
                                <div>
                                  <h4 className="font-medium text-gray-900">{hakemAdi}</h4>
                                  <p className="text-sm text-gray-500">
                                    {hakemDeƒüerlendirmeleri.length > 1 
                                      ? `${hakemDeƒüerlendirmeleri.length} deƒüerlendirme yapmƒ±≈ü` 
                                      : '1 deƒüerlendirme yapmƒ±≈ü'}
                                  </p>
                                </div>
                                <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                  sonDegerlendirme.durum === 'KABUL' ? 'bg-green-100 text-green-800' : 
                                  sonDegerlendirme.durum === 'RED' ? 'bg-red-100 text-red-800' : 
                                  'bg-yellow-100 text-yellow-800'
                                }`}>
                                  Son Karar: {sonDegerlendirme.durum === 'KABUL' ? 'Kabul' : 
                                             sonDegerlendirme.durum === 'RED' ? 'Red' : 'Revize'}
                                </span>
                              </div>
                              
                              <div className="divide-y divide-gray-200">
                                {hakemDeƒüerlendirmeleri.map((revize, index) => (
                                  <div key={revize.id || index} className="p-4 hover:bg-gray-50">
                                    <div className="flex justify-between mb-2">
                                      <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                        revize.durum === 'KABUL' ? 'bg-green-100 text-green-800' : 
                                        revize.durum === 'RED' ? 'bg-red-100 text-red-800' : 
                                        'bg-yellow-100 text-yellow-800'
                                      }`}>
                                        {revize.durum === 'KABUL' ? 'Kabul' : 
                                         revize.durum === 'RED' ? 'Red' : 'Revize'}
                                      </span>
                                      <span className="text-xs text-gray-500">
                                        {new Date(revize.createdAt || '').toLocaleDateString('tr-TR', {
                                          year: 'numeric',
                                          month: 'long',
                                          day: 'numeric',
                                          hour: '2-digit',
                                          minute: '2-digit'
                                        })}
                                      </span>
                                    </div>
                                    
                                    <div className="space-y-3 mt-3">
                                      {/* G√ºven Seviyesi */}
                                      {revize.guvenSeviyesi && (
                                        <div>
                                          <div className="text-xs font-medium text-gray-500 mb-1">G√ºven Seviyesi:</div>
                                          <div className="text-sm">{revize.guvenSeviyesi}/5</div>
                                        </div>
                                      )}
                                      
                                      {/* G√º√ßl√º Y√∂nler */}
                                      {revize.gucluYonler && (
                                        <div>
                                          <div className="text-xs font-medium text-gray-500 mb-1">G√º√ßl√º Y√∂nler:</div>
                                          <div className="text-sm whitespace-pre-wrap">{revize.gucluYonler}</div>
                                        </div>
                                      )}
                                      
                                      {/* Zayƒ±f Y√∂nler */}
                                      {revize.zayifYonler && (
                                        <div>
                                          <div className="text-xs font-medium text-gray-500 mb-1">Zayƒ±f Y√∂nler:</div>
                                          <div className="text-sm whitespace-pre-wrap">{revize.zayifYonler}</div>
                                        </div>
                                      )}
                                      
                                      {/* Genel Yorum */}
                                      {revize.genelYorum && (
                                        <div>
                                          <div className="text-xs font-medium text-gray-500 mb-1">Genel Yorum:</div>
                                          <div className="text-sm whitespace-pre-wrap">{revize.genelYorum}</div>
                                        </div>
                                      )}
                                      
                                      {/* Detaylƒ± deƒüerlendirme alanlarƒ± - buton ile a√ßƒ±lƒ±r kapanƒ±r */}
                                      {(revize.makaleTuru || revize.makaleBasligi || revize.soyut || 
                                        revize.anahtarKelimeler || revize.giris || revize.gerekcelerVeYontemler || 
                                        revize.sonuclarVeTartismalar || revize.referanslar || revize.guncellikVeOzgunluk) && (
                                        <div className="mt-4">
                                          <button 
                                            onClick={() => {
                                              const detayDiv = document.getElementById(`revize-detay-${revize.id}`);
                                              if (detayDiv) {
                                                detayDiv.classList.toggle('hidden');
                                              }
                                            }}
                                            className="text-blue-600 hover:text-blue-900 text-sm flex items-center"
                                          >
                                            <span>Detaylƒ± Deƒüerlendirmeyi G√∂ster</span>
                                            <svg className="h-4 w-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                          </button>
                                          
                                          <div id={`revize-detay-${revize.id}`} className="hidden mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            {/* Makale T√ºr√º */}
                                            {revize.makaleTuru && (
                                              <div className="bg-white p-2 rounded border border-gray-200">
                                                <div className="text-xs font-medium text-gray-500 mb-1">Makale T√ºr√º:</div>
                                                <div className="text-sm">{revize.makaleTuru}</div>
                                              </div>
                                            )}
                                            
                                            {/* Makale Ba≈ülƒ±ƒüƒ± */}
                                            {revize.makaleBasligi && (
                                              <div className="bg-white p-2 rounded border border-gray-200">
                                                <div className="text-xs font-medium text-gray-500 mb-1">Makale Ba≈ülƒ±ƒüƒ±:</div>
                                                <div className="text-sm">{revize.makaleBasligi}</div>
                                              </div>
                                            )}
                                            
                                            {/* Soyut */}
                                            {revize.soyut && (
                                              <div className="bg-white p-2 rounded border border-gray-200">
                                                <div className="text-xs font-medium text-gray-500 mb-1">√ñzet:</div>
                                                <div className="text-sm">{revize.soyut}</div>
                                              </div>
                                            )}
                                            
                                            {/* Anahtar Kelimeler */}
                                            {revize.anahtarKelimeler && (
                                              <div className="bg-white p-2 rounded border border-gray-200">
                                                <div className="text-xs font-medium text-gray-500 mb-1">Anahtar Kelimeler:</div>
                                                <div className="text-sm">{revize.anahtarKelimeler}</div>
                                              </div>
                                            )}
                                            
                                            {/* Giri≈ü */}
                                            {revize.giris && (
                                              <div className="bg-white p-2 rounded border border-gray-200">
                                                <div className="text-xs font-medium text-gray-500 mb-1">Giri≈ü:</div>
                                                <div className="text-sm">{revize.giris}</div>
                                              </div>
                                            )}
                                            
                                            {/* Gerek√ßeler ve Y√∂ntemler */}
                                            {revize.gerekcelerVeYontemler && (
                                              <div className="bg-white p-2 rounded border border-gray-200">
                                                <div className="text-xs font-medium text-gray-500 mb-1">Gerek√ßeler ve Y√∂ntemler:</div>
                                                <div className="text-sm">{revize.gerekcelerVeYontemler}</div>
                                              </div>
                                            )}
                                            
                                            {/* Sonu√ßlar ve Tartƒ±≈ümalar */}
                                            {revize.sonuclarVeTartismalar && (
                                              <div className="bg-white p-2 rounded border border-gray-200">
                                                <div className="text-xs font-medium text-gray-500 mb-1">Sonu√ßlar ve Tartƒ±≈ümalar:</div>
                                                <div className="text-sm">{revize.sonuclarVeTartismalar}</div>
                                              </div>
                                            )}
                                            
                                            {/* Referanslar */}
                                            {revize.referanslar && (
                                              <div className="bg-white p-2 rounded border border-gray-200">
                                                <div className="text-xs font-medium text-gray-500 mb-1">Referanslar:</div>
                                                <div className="text-sm">{revize.referanslar}</div>
                                              </div>
                                            )}
                                            
                                            {/* G√ºncellik ve √ñzg√ºnl√ºk */}
                                            {revize.guncellikVeOzgunluk && (
                                              <div className="bg-white p-2 rounded border border-gray-200">
                                                <div className="text-xs font-medium text-gray-500 mb-1">G√ºncellik ve √ñzg√ºnl√ºk:</div>
                                                <div className="text-sm">{revize.guncellikVeOzgunluk}</div>
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ) : (
                    <div className="py-4 text-center bg-gray-50 rounded-lg border border-gray-200">
                      <p className="text-gray-500">Bu bildiri i√ßin hen√ºz deƒüerlendirme yapƒ±lmamƒ±≈ü.</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
            
            <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
              <button
                onClick={() => setIsPreviewModalOpen(false)}
                className="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-50 transition-colors"
              >
                Kapat
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}